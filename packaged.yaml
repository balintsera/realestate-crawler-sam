AWSTemplateFormatVersion: '2010-09-09'
Description: 'Real estate crawler

  '
Globals:
  Function:
    Timeout: 40
Parameters:
  Table:
    AllowedValues:
    - RealEstate
    Default: RealEstate
    Type: String
Resources:
  Crawler:
    Properties:
      CodeUri: s3://serabalint-crawler-depl/956aaf1e0916ac910ae84de601661f77
      Environment:
        Variables:
          TABLE:
            Ref: Table
      Events:
        CheckWebsiteScheduledEvent:
          Enabled: false
          Properties:
            Schedule: rate(10 minutes)
          Type: Schedule
      Handler: index.handler
      Policies: AmazonDynamoDBFullAccess
      Runtime: nodejs8.10
    Type: AWS::Serverless::Function
  DataTableStream:
    Properties:
      BatchSize: 50
      Enabled: true
      EventSourceArn:
        Fn::GetAtt:
        - RealEstateData
        - StreamArn
      FunctionName:
        Fn::GetAtt:
        - DynamoStreamer
        - Arn
      StartingPosition: LATEST
    Type: AWS::Lambda::EventSourceMapping
  DynamoStreamer:
    Properties:
      CodeUri: s3://serabalint-crawler-depl/8c5b29f6fc505df2bf497b4a3132c2d0
      Environment:
        Variables:
          TABLE:
            Ref: Table
      Handler: index.handler
      Policies:
      - AmazonDynamoDBFullAccess
      - AmazonSESFullAccess
      Runtime: nodejs8.10
    Type: AWS::Serverless::Function
  RealEstateData:
    Properties:
      AttributeDefinitions:
      - AttributeName: ID
        AttributeType: S
      KeySchema:
      - AttributeName: ID
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      TableName:
        Ref: Table
    Type: AWS::DynamoDB::Table
Transform: AWS::Serverless-2016-10-31
